---
version: 0.2

phases:
  install:
    commands:
      - nohup /usr/local/bin/dockerd --host=unix:///var/run/docker.sock --host=tcp://0.0.0.0:2375 --storage-driver=overlay&
      - timeout -t 15 sh -c "until docker info; do echo .; sleep 1; done"
      - |
        apk add --update --no-cache \
        ca-certificates \
        openssh-client \
        openssl \
        python \
        py-pip \
        curl
      - pip install awscli
      - apk add --update --no-cache jq
  pre_build:
    commands:
      - aws --version
      - docker version
      - $(aws ecr get-login --region $AWS_DEFAULT_REGION --no-include-email)
      - docker pull $REPOSITORY_URI:latest || true
      - cd ./containers/jmeter-$TARGET_CONTAINER_IMAGE
      - |
        if [ "${TARGET_CONTAINER_IMAGE}" = "server" ]; then
        DOMAIN=$(cat ../../runtime-info.json | jq -r .Domain)
        cat << EOS > senario.properties
        domain=${DOMAIN}
        EOS
        cat senario.properties
        fi
  build:
    commands:
      - echo Build started on `date`
      - echo Building the Docker image...
      - |
        docker build --cache-from $REPOSITORY_URI:latest --tag $REPOSITORY_URI:latest .
      - docker image list
  post_build:
    commands:
      - echo Pushing the Docker images...
      - docker push $REPOSITORY_URI:latest
      - echo Build completed on `date`
